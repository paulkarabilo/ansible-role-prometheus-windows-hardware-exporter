name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
    molecule-windows-runner:
        runs-on: windows-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Create local WINRM user
              run: |
                    $Username = "Molecule"
                    $Password = -join ((48..57) + (97..122) | Get-Random -Count 32 | % {[char]$_})

                    echo "::add-mask::$Password"
                    $SecurePassword = ConvertTo-SecureString $Password -AsPlainText -Force
                    if (-not (Get-LocalUser -Name $Username -ErrorAction SilentlyContinue)) {
                        Write-Host "Creating user $Username"
                        New-LocalUser -Name $Username -Password $SecurePassword -AccountNeverExpires -PasswordNeverExpires
                    } else {
                        Write-Host "User $Username already exists"
                        Set-LocalUser -Name $Username -Password $SecurePassword
                    }
                    Add-LocalGroupMember -Group "Administrators" -Member $Username -ErrorAction SilentlyContinue

                    winrm quickconfig -q
                    winrm set winrm/config/service/auth '@{Negotiate="true";NTLM="true"}'

                    New-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name "LocalAccountTokenFilterPolicy" -Value 1 -PropertyType DWord -Force | Out-Null

                    winrm enumerate winrm/config/listener

                    Add-Content $env:GITHUB_ENV "WINDOWS_RUNNER_USER=$Username"
                    Add-Content $env:GITHUB_ENV "WINDOWS_RUNNER_PASSWORD=$Password"

            - name: Setup WSL Ubuntu
              uses: Vampire/setup-wsl@v6
              with:
                  distribution: Ubuntu-22.04

            - name: Install test dependencies in WSL
              shell: wsl-bash
              run: |
                    set -euxo pipefail
                    sudo apt-get update
                    sudo apt-get install -y python3 python3-pip python3-venv
                    python3 -m venv .venv
                    . .venv/bin/activate
                    pip install -U pip
                    pip install -r requirements.txt
                    ansible --version
                    molecule --version

            - name: Run Molecule tests
              shell: wsl-bash
              env:
                  WINDOWS_RUNNER_USER: ${{ env.WINDOWS_RUNNER_USER }}
                  WINDOWS_RUNNER_PASSWORD: ${{ env.WINDOWS_RUNNER_PASSWORD }}
              run: |
                    set -euxo pipefail
                    . .venv/bin/activate
                    molecule test -s windows-runner