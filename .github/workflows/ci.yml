name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
    molecule-windows-runner:
        runs-on: windows-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Create local WINRM user
              env:
                  WINDOWS_RUNNER_USER: ${{ secrets.WINDOWS_RUNNER_USER  }}
                  WINDOWS_RUNNER_PASSWORD: ${{ secrets.WINDOWS_RUNNER_PASSWORD }}
              run: |
                  echo "::add-mask::$env:WINDOWS_RUNNER_PASSWORD"
                  $SecurePassword = ConvertTo-SecureString $env:WINDOWS_RUNNER_PASSWORD -AsPlainText -Force
                  if (-not (Get-LocalUser -Name $env:WINDOWS_RUNNER_USER -ErrorAction SilentlyContinue)) {
                      Write-Host "Creating user $env:WINDOWS_RUNNER_USER"
                      New-LocalUser -Name $env:WINDOWS_RUNNER_USER -Password $SecurePassword -AccountNeverExpires -PasswordNeverExpires
                  } else {
                      Write-Host "User $env:WINDOWS_RUNNER_USER already exists"
                      Set-LocalUser -Name $env:WINDOWS_RUNNER_USER -Password $SecurePassword
                  }
                  Add-LocalGroupMember -Group "Administrators" -Member $env:WINDOWS_RUNNER_USER -ErrorAction SilentlyContinue

                  winrm quickconfig -q
                  winrm set winrm/config/service/auth '@{Negotiate="true";NTLM="true"}'
                  New-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name "LocalAccountTokenFilterPolicy" -Value 1 -PropertyType DWord -Force | Out-Null

                  winrm enumerate winrm/config/listener

            - name: Setup WSL Ubuntu
              uses: Vampire/setup-wsl@v6
              with:
                  distribution: Ubuntu-22.04

            - name: Install test dependencies in WSL
              shell: wsl-bash {0}
              run: |
                  set -euxo pipefail
                  sudo apt update -y
                  sudo apt upgrade -y
                  sudo apt install software-properties-common -y
                  sudo add-apt-repository ppa:deadsnakes/ppa -y
                  sudo apt update -y
                  sudo apt install -y python3.12 python3.12-venv python3.12-dev python3-pip
                  python3.12 -m venv .venv
                  . .venv/bin/activate
                  pip install -U pip
                  pip install -r requirements.txt
                  ansible --version
                  molecule --version

            - name: Run Molecule tests
              shell: wsl-bash
              env:
                  WINDOWS_RUNNER_USER: ${{ env.WINDOWS_RUNNER_USER }}
                  WINDOWS_RUNNER_PASSWORD: ${{ env.WINDOWS_RUNNER_PASSWORD }}
              run: |
                  set -euxo pipefail
                  . .venv/bin/activate
                  molecule test -s windows-runner